# -*- coding: utf-8 -*-
"""evaluate_network.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TEurC6hNtLerKKm47UnjoOAgGzfQYcDr
"""

# =============================================================
# evaluate_network_bitboard.py
#   - latest.h5 ã¨ best.h5 ã‚’å¯¾æˆ¦ã•ã›å¹³å‡ãƒã‚¤ãƒ³ãƒˆã‚’ç®—å‡º
#   - å¹³å‡ > 0.5 ãªã‚‰ best.h5 ã‚’æ›´æ–°
# =============================================================
from pathlib import Path
from shutil import copy
import numpy as np
from tensorflow.keras.models import load_model
from tensorflow.keras import backend as K

from game       import State                 # ãƒ“ãƒƒãƒˆãƒœãƒ¼ãƒ‰ State
from pv_mcts    import pv_mcts_action        # ãƒ“ãƒƒãƒˆãƒœãƒ¼ãƒ‰å¯¾å¿œç‰ˆ

# -------------------- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ --------------------
EN_GAME_COUNT  = 200     # è©•ä¾¡ã‚²ãƒ¼ãƒ æ•° (æœ¬å®¶400)
EN_TEMPERATURE = 0.05    # ãƒœãƒ«ãƒ„ãƒãƒ³æ¸©åº¦0.1â†’0.05

# -------------------- ãƒã‚¤ãƒ³ãƒˆè¨ˆç®— -------------------
def first_player_point(ended_state: State) -> float:
    if ended_state.is_lose():
        return 0.0 if ended_state.is_first_player() else 1.0
    return 0.5   # å¼•ãåˆ†ã‘

# -------------------- 1 ã‚²ãƒ¼ãƒ å®Ÿè¡Œ -------------------
def play(next_actions):
    """next_actions = (å…ˆæ‰‹AI, å¾Œæ‰‹AI)"""
    state = State()
    while not state.is_done():
        action_fn = next_actions[0] if state.is_first_player() else next_actions[1]
        action    = action_fn(state)                 # ã‚»ãƒ« index
        state     = state.next_from_index(action)    # â˜… ãƒ“ãƒƒãƒˆãƒœãƒ¼ãƒ‰ç”¨
    return first_player_point(state)

# -------------------- best ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–° -------------
def update_best_player():
    copy("./model/latest.h5", "./model/best.h5")
    print("ğŸ†  best.h5 ã‚’æ›´æ–°ã—ã¾ã—ãŸ")

# -------------------- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è©•ä¾¡ ----------------
def evaluate_network():
    # --- ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ (compile=False ã§è­¦å‘ŠæŠ‘æ­¢) ---
    model_latest = load_model("./model/latest.h5", compile=False)
    model_best   = load_model("./model/best.h5",   compile=False)

    # --- è¡Œå‹•é–¢æ•° ---
    next_latest = pv_mcts_action(model_latest, EN_TEMPERATURE)
    next_best   = pv_mcts_action(model_best,   EN_TEMPERATURE)
    pair = (next_latest, next_best)

    # --- å¯¾æˆ¦ ---
    total = 0.0
    for i in range(EN_GAME_COUNT):
        if i % 2 == 0:                  # å¶æ•°å±€ï¼šlatest å…ˆæ‰‹
            total += play(pair)
        else:                           # å¥‡æ•°å±€ï¼šbest å…ˆæ‰‹
            total += 1.0 - play(pair[::-1])
        print(f"\rEvaluate {i+1}/{EN_GAME_COUNT}", end="")
    print()

    avg = total / EN_GAME_COUNT
    print("Average Point:", avg)

    # --- å¾Œå§‹æœ« ---
    K.clear_session(); del model_latest, model_best

    # --- best æ›´æ–°åˆ¤å®š ---
    if avg < 0.48:                        # é–¾å€¤ã‚’å¤‰æ›´
        update_best_player()
        return True
    return False

# -------------------- å‹•ä½œç¢ºèª ------------------------
if __name__ == "__main__":
    evaluate_network()
