# -*- coding: utf-8 -*-
"""play_best.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19VOgYtV654vqdFP4rHGW-RDBojDYCJhK
"""

# Commented out IPython magic to ensure Python compatibility.
import os, json, time, shutil
from pathlib import Path
from google.colab import drive
from tensorflow.keras import backend as K

# ---------- 0) Google Drive ----------
drive.mount('/content/drive', force_remount=False)

ROOT = Path('/content/drive/MyDrive/azero_3d')
MODEL_DIR = ROOT / 'model'
DATA_DIR  = ROOT / 'data'
MODEL_DIR.mkdir(parents=True, exist_ok=True)
DATA_DIR.mkdir(exist_ok=True)

# ---------- 1) ã‚³ãƒ¼ãƒ‰ç½®ãå ´ã«ç§»å‹• ----------
# %cd /content/drive/MyDrive/sample/3dyonnmoku/train_code_new
import sys; sys.path.append(os.getcwd())

# play_best.py
"""
äººé–“ vs best.h5 ï¼ˆPV-MCTS 800 ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰å¯¾å±€ UI
--------------------------------------------------------
å®Ÿè¡Œæ–¹æ³•:  python play_best.py
"""

import sys, random
from pathlib import Path
from tensorflow.keras.models import load_model
from pv_mcts import pv_mcts_action
from typing import List

# ===== ç›¤é¢ã‚¯ãƒ©ã‚¹ =====
# å…ˆã»ã©ã® State ã‚’ãã®ã¾ã¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from game import State, SIZE, idx

# ====== best.h5 ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€æ¨è«–é–¢æ•°ã‚’ä½œã‚‹ ======
BEST_PATH = Path("/content/drive/MyDrive/azero_3d/model/best.h5")
if not BEST_PATH.exists():
    sys.exit("âŒ best.h5 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å­¦ç¿’ or ã‚³ãƒ”ãƒ¼å¾Œã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")

print("ğŸ“‚ loading model ...", end="", flush=True)
model = load_model(BEST_PATH, compile=False)

ai_policy_value = pv_mcts_action(model, temperature = 0, num_simulations = 2000, add_noise = False)   # æ¨è«–é–¢æ•° (= Stateâ†’int)
print(" done.\n")
# ===================== ãƒ˜ãƒ«ãƒ—æ–‡å­—åˆ— =====================
def print_help():
    print("  - x y : ã‚ãªãŸã®æ‰‹ (ä¾‹ 1 2)")
    print("  - undo / u / å¾…ã£ãŸ : ç›´å‰ã® AI æ‰‹ + ã‚ãªãŸã® 1 æ‰‹ã‚’å–ã‚Šæ¶ˆã—")
    print("  - quit / exit : çµ‚äº†\n")

# ===================== è¿½åŠ ï¼šå®šçŸ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====================
JOSEKI_PARALLEL = [(0,0), (3,3), (0,3), (3,0)]  # x,y   â€»z ã¯é‡åŠ›ã§è‡ªå‹•æ±ºå®š

def apply_joseki(state: State, moves=JOSEKI_PARALLEL) -> State:
    """
    ä¸ãˆã‚‰ã‚ŒãŸ (x,y) ãƒªã‚¹ãƒˆã‚’å…ˆé ­ã‹ã‚‰é †ã«æ‰“ã¡è¾¼ã‚€ã€‚
    gravity ä»˜ããªã®ã§æœ€ã‚‚ä½ã„ z ã«çŸ³ãŒå…¥ã‚‹ã€‚
    å¥‡æ•°ç•ªç›®ï¼å…ˆæ‰‹ã€å¶æ•°ç•ªç›®ï¼å¾Œæ‰‹ã¨ã—ã¦è‡ªå‹•ã§ pieces/enemy_pieces ã‚’åè»¢ã€‚
    """
    for x,y in moves:
        # State.place ã¯ã€Œç¾æ‰‹ç•ªã€å´ãŒæ‰“ã¤ â†’ player swap æ¸ˆã¿ state ãŒå¸°ã‚‹
        state = state.place(x,y)
    return state

# ------------------------------------------------------------------
def human_action(state: State) -> int:
    """x y å…¥åŠ›ã‚’ z=0 èµ·ç‚¹ã§ä¸‹ã‹ã‚‰æ¢ç´¢"""
    while True:
        try:
            raw = input("ã‚ãªãŸã®æ‰‹ (x y) â†’ ").strip()
            if raw.lower() in ("quit", "exit"): sys.exit(0)
            x, y = map(int, raw.split())
            if not (0 <= x < SIZE and 0 <= y < SIZE):
                raise ValueError
        except ValueError:
            print("å…¥åŠ›ã¯ 0â€“3 ã®æ•´æ•° 2 ã¤ã§ã™ã€‚ä¾‹: 1 2")
            continue

        for z in range(SIZE):
            i = idx(x, y, z)          # staticmethod ã‚’ç›´æ¥å‘¼ã¹ã‚‹
            if (state.pieces | state.enemy_pieces) >> i & 1 == 0:
                return i
        print("ãã®åˆ—ã¯æº€æ¯ã§ã™ã€‚åˆ¥ã®åˆ—ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")

# ------------------------------------------------------------------
def game_loop():
    # --- å…ˆæ‰‹ãƒ»å¾Œæ‰‹ã®é¸æŠ -----------------------------------------
    while True:
        ans = input("å…ˆæ‰‹ã§ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ (y/n) â†’ ").strip().lower()
        if ans in ("y", "yes"):  human_first = True;  break
        if ans in ("n", "no"):   human_first = False; break
        print("y ã‹ n ã§ç­”ãˆã¦ãã ã•ã„ã€‚")

    state = State()
    # --- å®šçŸ³ã‚’ä½¿ã†ã‹ç¢ºèª ------------------------------------------
    ans = input("æœ€åˆã«ä¸¦è¡Œå®šçŸ³ 0 0-3 3-0 3-3 0 ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ (y/n) â†’ ").strip().lower()
    use_joseki = ans in ("y", "yes")

    state = State()
    if use_joseki:
        state = apply_joseki(state)
    print("\n=== ç«‹ä½“å››ç›®ï¼ˆPV-MCTS ä»˜ã best.h5ï¼‰===")
    if human_first:
        print("[ã‚ãªãŸ] å…ˆæ‰‹  /  [AI] å¾Œæ‰‹")
    else:
        print("[AI] å…ˆæ‰‹  /  [ã‚ãªãŸ] å¾Œæ‰‹")
    print(state, "\n")

    # ---------- ç›¤é¢å±¥æ­´ï¼ˆå¾…ã£ãŸç”¨ï¼‰ ----------
    history: List[State] = [state]     # ç¾åœ¨ã®ç›¤é¢ã‚’å¸¸ã«æœ«å°¾ã«ä¿æŒ

    # --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---------------------------------------------
    while not state.is_done():
        human_turn = (state.is_first_player() and human_first) or \
                     (not state.is_first_player() and not human_first)

        if human_turn:
            # ---------- äººé–“å…¥åŠ› ----------
            while True:
                raw = input("ã‚ãªãŸã®æ‰‹ (x y / undo / help) â†’ ").strip().lower()

                # --- undo -----------------
                if raw in ("undo", "u", "å¾…ã£ãŸ"):
                    if len(history) <= 1:
                        print("âš  ã“ã‚Œä»¥ä¸Šæˆ»ã‚Œã¾ã›ã‚“")
                        continue
                    # ç›´å‰ AI æ‰‹ & ã‚ãªãŸã®æ‰‹ã‚’å–ã‚Šæ¶ˆã—
                    history.pop()              # = ç›´å‰ AI æ‰‹
                    if len(history) > 1:
                        history.pop()          # = ã‚ãªãŸã®å‰å›æ‰‹
                    state = history[-1]
                    print(state, "\n(å¾…ã£ãŸã—ã¾ã—ãŸã€‚ã‚ãªãŸã®ç•ªã§ã™)")
                    continue      # å†åº¦å…¥åŠ›å¾…ã¡

                # --- help -----------------
                if raw in ("h", "help", "?"):
                    print_help(); continue

                # --- quit -----------------
                if raw in ("quit", "exit"):
                    raise SystemExit

                # --- åº§æ¨™å…¥åŠ› ---------------
                try:
                    x, y = map(int, raw.split())
                    move = None
                    for z in range(SIZE):
                        i = idx(x, y, z)
                        if (state.pieces | state.enemy_pieces) >> i & 1 == 0:
                            move = i; break
                    if move is None:
                        print("ãã®åˆ—ã¯æº€æ¯ã§ã™ã€‚")
                        continue
                    break
                except Exception:
                    print("å½¢å¼ã‚¨ãƒ©ãƒ¼: 0â€“3 ã®æ•´æ•° 2 ã¤ã‚’å…¥åŠ›")
                    continue

            print("\nã‚ãªãŸã®æ‰‹:")
        else:
            move = ai_policy_value(state)  # â† best.h5 + PV-MCTS
            print("AI ã®æ‰‹:", f"({move%SIZE}, {(move//SIZE)%SIZE}) z?")

        state = state.next_from_index(move)
        history.append(state)
        print(state, "\n")

    # --- å‹æ•—åˆ¤å®š --------------------------------------------------
    if state.is_draw():
        print("å¼•ãåˆ†ã‘ã€‚")
    else:
        winner_is_human = human_turn  # æœ€å¾Œã«æŒ‡ã—ãŸå´ãŒå‹ã¡
        print("ã‚ãªãŸã®å‹ã¡ï¼ğŸ‰" if winner_is_human else "AI ã®å‹ã¡â€¦ğŸ’¦")

# ------------------------------------------------------------------
if __name__ == "__main__":
    try:
        game_loop()
    except KeyboardInterrupt:
        print("\nå¼·åˆ¶çµ‚äº†ã—ã¾ã—ãŸã€‚")